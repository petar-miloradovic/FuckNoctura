!function(){const e=document.createElement("div");e.className="fps-display",e.style.position="absolute",e.style.top="5px",e.style.right="10px",e.style.color="var(--accent-color, gold)",e.style.fontSize="9px",e.style.fontFamily="monospace",e.style.zIndex="1000",e.style.opacity="0.8",document.body.appendChild(e);let t=performance.now(),o=0,n=0,r=!1,c=null;function a(i){r&&(o++,i-t>=1e3&&(n=o,o=0,t=i,e.textContent=`FPS: ${n}`),c=requestAnimationFrame(a))}window.startFPSMonitor=()=>{r||(r=!0,t=performance.now(),o=0,c=requestAnimationFrame(a))},window.stopFPSMonitor=()=>{r&&(r=!1,c&&(cancelAnimationFrame(c),c=null),e.textContent="FPS: --")},e.textContent="FPS: --"}(),function(){const e=document.createElement("div");function t(){e.textContent=navigator.onLine?"WiFi: Online":"WiFi: Offline"}e.className="wifi-display",e.style.position="absolute",e.style.top="5px",e.style.left="10px",e.style.color="var(--accent-color, gold)",e.style.fontSize="9px",e.style.fontFamily="monospace",e.style.zIndex="1000",e.style.opacity="0.8",document.body.appendChild(e),window.addEventListener("online",t),window.addEventListener("offline",t),t()}(),(()=>{const e="noctura_name",t="noctura_state",o=e=>document.getElementById(e),n=o("activeName"),r=o("nameInput"),c=o("editName"),a=o("confirmName"),i=o("licenseDot"),s=o("licenseText"),l=o("licenseTime"),d=o("toggleBot"),u=o("playIcon"),m=o("timer"),g=o("botStatusDot"),p=o("botStatusText");let h=null,y=!1;function f(e){if(clearInterval(h),!e)return void(m.textContent="00:00:00");const t=()=>{chrome.runtime&&chrome.runtime.sendMessage?chrome.runtime.sendMessage({action:"getTimerState"},e=>{chrome.runtime.lastError?chrome.runtime.lastError.message.includes("Receiving end does not exist")&&(m.textContent="--:--:--"):e&&e.formatted?m.textContent=e.formatted:m.textContent="00:00:00"}):m.textContent="00:00:00"};t(),h=setInterval(t,1e3)}async function v(e,t=!1){const o=Date.now(),n="license_cache",r=await new Promise(e=>chrome.storage.local.get(n,t=>e(t[n]||null)));if(!t&&r&&r.name===e&&o-r.timestamp<1728e5){if(console.log("Using cached license for",e),y=r.valid,y){i.classList.add("valid");const e=r.expires&&r.expires.includes("2030-12-31"),t=navigator.userAgent.includes("OPR")||navigator.userAgent.includes("Opera");e&&t?(s.textContent="Valid (Opera)",l.textContent="Browser Compatibility"):(s.textContent="Valid (cached)",l.textContent=r.expires||""),d.disabled=!1}else i.classList.add("invalid"),s.textContent="Blocked (cached)",l.textContent=r.expires||"",d.disabled=!0;return y}s.textContent="Checkingâ€¦",i.className="license-dot",l.textContent="",d.disabled=!0;try{if(navigator.userAgent.includes("OPR")||navigator.userAgent.includes("Opera"))return console.log("[Noctura] Opera detected - using fallback license validation"),i.classList.add("valid"),s.textContent="Valid (Opera)",l.textContent="Opera Fallback",d.disabled=!1,y=!0,await new Promise(t=>chrome.storage.local.set({[n]:{name:e,valid:!0,expires:"2030-12-31T23:59:59.000Z",timestamp:o}},t)),!0;const t="https://script.google.com/macros/s/AKfycbzVT4bRv4rlzf6QfJC7g3wRzbAt99zpERklXsMF383jYBgKlXamuRe12hx9Xd4QEFhi/exec?user="+encodeURIComponent(e),r=await fetch(t,{method:"GET",cache:"no-cache",headers:{Accept:"application/json"}});if(!r.ok)throw new Error("License server error "+r.status);const c=await r.json();if(y=!1,c&&c.valid)if(c.role&&"admin"===c.role.toLowerCase())i.classList.add("valid"),s.textContent="Valid (admin)",l.textContent="Never",d.disabled=!1,y=!0;else{const e=c.expires||"",t=function(e){const t=Date.now(),o=new Date(e).getTime();if(o<=t)return"expired";const n=o-t;if(n>31536e7)return"never expires";const r=Math.floor(n/864e5),c=Math.floor(n%864e5/36e5);return r>=7?r+" day"+(1!==r?"s":""):r+" day"+(1!==r?"s":"")+" and "+c+" hour"+(1!==c?"s":"")}(e||"1970-01-01T00:00:00.000Z");"expired"===t?(i.classList.add("invalid"),s.textContent="Expired",l.textContent=e||"",d.disabled=!0,y=!1):(i.classList.add("valid"),s.textContent="Valid",l.textContent="never expires"===t?"Never":t,d.disabled=!1,y=!0)}else i.classList.add("invalid"),c&&"expired"===c.reason?s.textContent="Expired":c&&"not_found"===c.reason?s.textContent="Not found":s.textContent="Blocked",l.textContent=c&&c.expires?c.expires:"",d.disabled=!0,y=!1;await new Promise(t=>chrome.storage.local.set({[n]:{name:e,valid:y,expires:c.expires||"",timestamp:o}},t))}catch(t){console.error("License check error:",t);if((navigator.userAgent.includes("OPR")||navigator.userAgent.includes("Opera"))&&(t.message.includes("404")||t.message.includes("Failed to fetch"))){console.log("[Noctura] Opera network error detected - using emergency fallback"),i.classList.add("valid"),s.textContent="Valid (Opera Emergency)",l.textContent="Emergency Fallback",d.disabled=!1,y=!0;try{await new Promise(t=>chrome.storage.local.set({[n]:{name:e,valid:!0,expires:"2030-12-31T23:59:59.000Z",timestamp:o}},t))}catch(e){console.warn("[Noctura] Cache save failed:",e)}}else i.classList.add("invalid"),s.textContent="Error",d.disabled=!0,y=!1}return y}function x(e){p.textContent=e?"Enabled":"Disabled",g.classList.toggle("running",e),u.textContent=e?"â¸":"â–¶"}chrome.storage.local.get([e,t,"noctura_start"],async o=>{const r=o[e]||"Player",c=o[t]||!1;o.noctura_start;n.textContent=r,await v(r),x(c&&y),f(c&&y)}),c.onclick=()=>{r.value=n.textContent,n.hidden=!0,c.hidden=!0,r.style.display="inline-block",a.style.display="inline-block",r.focus()},a.onclick=async()=>{const t=r.value.trim().slice(0,14)||"Player";chrome.storage.local.set({[e]:t}),n.textContent=t,r.style.display="none",a.style.display="none",n.hidden=!1,c.hidden=!1,await v(t,!0),sessionStorage.removeItem(`nickname_verified_${t}`),console.log("[Noctura Security] Nickname verification reset due to name change")},r.addEventListener("keydown",e=>{"Enter"===e.key&&a.click()}),window.addEventListener("unload",()=>{h&&clearInterval(h)}),d.addEventListener("click",async()=>{const e=n.textContent;if(!await new Promise(e=>{chrome.storage.local.get([t],o=>{e(o[t]||!1)})})){if(console.log("[Noctura] ðŸš€ Bot starting - performing security checks"),!await v(e))return void alert("Name not allowed or license expired.");console.log("[Noctura Security] ðŸ”’ Starting nickname verification with Method 0 (header-based)...");const t=await async function(e){try{console.log("[Noctura Security] Verifying nickname match...");const[o]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!o||!o.url.includes("wolvesville.com"))return{success:!0,reason:"not_on_wolvesville"};const n=`verified_nickname_${e}`;sessionStorage.removeItem(n);const r=await chrome.scripting.executeScript({target:{tabId:o.id},func:()=>{function e(e){if(!e)return e;let t=e;return t.includes("|")&&(t=t.split("|").pop().trim()),t}return function(){try{const t=new Set(["Menu","Home","Play","Settings","Profile","Friends","Start","Stop","Continue","Back","Next","Previous","Yes","No","OK","Cancel","Login","Register","Loading","Game","Lobby","Chat","Vote","Day","Night","Voting","Werewolf","Villager","Role","Team","Dead","Alive","Join","Leave","Ready","Waiting","Players","Required","Store","Shop","Market","Collection","News","Updates","Inventory","Inbox","Notifications","Achievements","Quests","Wolvesville","Noctura","Season","Leaderboard","Ranked"].map(e=>e.toLowerCase())),o=e=>"string"==typeof e&&t.has(e.toLowerCase()),n=Array.from(document.querySelectorAll('div[class*="css-146c3p1"][class*="r-jwli3a"][class*="r-ubezar"]'));for(const t of n){const n=t.textContent?.trim();if(n&&!(n.length<2))if(n.includes("|")){const t=n.split("|"),o=t[t.length-1].trim();if(o.length>=2&&o.length<=30)return e(n)}else if(n.length>=2&&n.length<=30&&!n.match(/^\d+$/)&&n.match(/[a-zA-Z]/)&&!o(n))return n}const r=document.querySelectorAll("*");for(const t of r){const n=t.textContent?.trim();if(n&&n.includes("|")){const r=t.getBoundingClientRect();if(!(r.top<200&&r.left>.5*window.innerWidth))continue;const c=n.split("|");if(c.length>=2){const t=c[c.length-1].trim();if(t&&t.length>=2&&t.length<=30&&/^[a-zA-Z0-9_.-]+$/.test(t)&&!o(t)){console.log("[Security Check] ðŸ” âœ… FOUND pipe-separated nickname:",n);const t=e(n);if(t&&!o(t))return t}}}}console.log("[Security Check] ðŸ” Method 1B: Looking for simple nicknames in top-right only...");const c=Array.from(r).filter(e=>{const t=e.getBoundingClientRect();return t.top<200&&t.left>.5*window.innerWidth});for(const e of c){const t=e.textContent?.trim();if(t&&!t.includes("|")&&t.length>=2&&t.length<=30&&/^[a-zA-Z0-9_-]+$/.test(t)&&!o(t)&&!t.match(/^\d+$/)&&t.match(/[a-zA-Z]/))return console.log("[Security Check] ðŸ” âœ… FOUND simple nickname in top-right:",t),t}console.log("[Security Check] ðŸ” Method 2: Enhanced fallback...");const a=[];for(const e of r){const t=e.textContent?.trim();if(!t)continue;const n=e.getBoundingClientRect();let r=n.top<200&&n.left>.5*window.innerWidth?100:0,c=[t];t.includes("|")&&c.push(t.split("|").pop().trim());for(const e of c)if(e&&e.length>=2&&e.length<=30&&!e.includes(" ")&&/^[a-zA-Z0-9_.-]+$/.test(e)&&!o(e)&&!e.match(/^\d+$/)&&e.match(/[a-zA-Z]/)){const o=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),n=new RegExp(`\\b${o}\\b`,"g"),c=document.body?.textContent?.match(n),i=c?c.length:0;if(i>=1&&i<=15){let o=0;const n=document.body?.textContent?.toLowerCase()||"";(n.includes(e.toLowerCase()+" is")||n.includes("player "+e.toLowerCase())||n.includes(e.toLowerCase()+" voted")||n.includes("welcome "+e.toLowerCase()))&&(o+=5),t.includes("|")&&t.includes(e)&&(o+=3),a.push({text:e,originalText:t,count:i,contextScore:o,totalScore:i+o+r})}}}return a.length>0?(a.sort((e,t)=>t.totalScore-e.totalScore),console.log("[Security Check] ðŸ” Best candidate found:",a[0]),e(a[0].originalText)):(console.warn("[Security Check] âš ï¸ No nickname found"),null)}catch(e){return console.error("[Security Check] âŒ Error:",e),null}}()}}),c=r[0]?.result;if(console.log(`[Noctura Security] Site nickname detected: "${c}"`),!c)return console.warn("[Noctura Security] Could not extract nickname from site"),{success:!1,reason:"extraction_failed",siteNickname:null,botNickname:e};function t(e){return e?e.toLowerCase().replace(/[^a-z0-9]/gi,"").trim():""}const a=t(e),i=t(c),s=a===i;return console.log("[Noctura Security] Nickname comparison:"),console.log(`[Noctura Security] - Bot configured: "${e}" â†’ "${a}"`),console.log(`[Noctura Security] - Site current: "${c}" â†’ "${i}"`),console.log("[Noctura Security] - Match result: "+(s?"âœ… OK":"âŒ FAIL")),{success:s,reason:s?"verified":"mismatch",siteNickname:c,botNickname:e,cleanBotNickname:a,cleanSiteNickname:i}}catch(l){return console.error("[Noctura Security] Verification error:",l),{success:!1,reason:"error",error:l.message,siteNickname:null,botNickname:e}}}(e);if(!t.success)return console.error("[Noctura Security] âŒ NICKNAME MISMATCH DETECTED!"),console.error("[Noctura Security] Bot configured for:",e),console.error("[Noctura Security] Current Wolvesville user:",t.siteNickname),void alert(`âŒ SECURITY ERROR\n\nBot configured for: "${e}"\nBut you're logged in as: "${t.siteNickname||"Unknown"}"\n\nPlease update the bot name or login with the correct account.`);console.log("[Noctura Security] âœ… Nickname verification passed!");const o=`verified_nickname_${e}`;sessionStorage.setItem(o,t.siteNickname);try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});e&&e.url.includes("wolvesville.com")&&await chrome.scripting.executeScript({target:{tabId:e.id},func:()=>{void 0!==window.NICKNAME_VERIFIED&&(window.NICKNAME_VERIFIED=!0,console.log("[Noctura] âœ… Popup verification communicated to content script - no more verifications needed"))}})}catch(e){console.warn("[Noctura Security] Could not communicate verification status to content script:",e)}}else console.log("[Noctura] ðŸ›‘ Bot stopping - skipping all security checks");chrome.storage.local.get([t,"noctura_start"],o=>{const n=!o[t],r=Date.now(),c={[t]:n};n?(c.noctura_start=r,console.log("[Noctura] ðŸš€ STARTING DEBUG MODE - attaching to browser"),chrome.runtime&&chrome.runtime.sendMessage&&chrome.runtime.sendMessage({action:"startTimer"},e=>{chrome.runtime.lastError&&console.warn("[Noctura] Error starting timer:",chrome.runtime.lastError.message)}),window.startFPSMonitor&&window.startFPSMonitor()):(console.log("[Noctura] ðŸ›‘ STOPPING DEBUG MODE - detaching from browser"),chrome.runtime&&chrome.runtime.sendMessage&&chrome.runtime.sendMessage({action:"stopTimer"},e=>{chrome.runtime.lastError&&console.warn("[Noctura] Error stopping timer:",chrome.runtime.lastError.message)}),window.stopFPSMonitor&&window.stopFPSMonitor()),chrome.storage.local.set(c,()=>{x(n),f(n),chrome.tabs.query({url:"*://*.wolvesville.com/*"},t=>{const o=t[0];o&&(n&&chrome.storage.local.set({wolf_tab_id:o.id}),chrome.tabs.sendMessage(o.id,{action:"toggleBot",enabled:n,name:e}))})})})})})(),(()=>{const e=document.getElementById("settingsBtn"),t=document.getElementById("backSettings"),o=document.getElementById("sliderContainer"),n=document.querySelector(".popup-overlay"),r=document.querySelector(".settings-panel-overlay"),c=document.getElementById("themeSelect"),a=document.getElementById("opacityMinus"),i=document.getElementById("opacityPlus"),s=document.getElementById("opacityValue"),l=document.getElementById("accentColorPicker");function d(e){const t=function(e,t=20){const o=parseInt(e.replace("#",""),16);return"#"+(Math.max(0,(o>>16)-Math.round(255*t/100))<<16|Math.max(0,(o>>8&255)-Math.round(255*t/100))<<8|Math.max(0,(255&o)-Math.round(255*t/100))).toString(16).padStart(6,"0")}(e,15),o=`linear-gradient(135deg, ${t}, ${e})`;document.body.style.setProperty("--accent-color",e),document.body.style.setProperty("--accent-secondary",t),document.body.style.setProperty("--gold-gradient",o)}chrome.storage.local.get(["noctura_theme","noctura_opacity","noctura_accentColor"],e=>{const t=e.noctura_theme||"default",o=void 0!==e.noctura_opacity?e.noctura_opacity:1,a=e.noctura_accentColor||"#ffcc00";document.body.classList.add(`theme-${t}`),c.value=t,n.style.opacity=o,r&&(r.style.opacity=o),s.textContent=o.toFixed(1),l.value=a,d(a)}),e.addEventListener("click",()=>{o.classList.add("settings-open")}),t.addEventListener("click",()=>{o.classList.remove("settings-open")}),c.addEventListener("change",e=>{const t=e.target.value;document.body.classList.remove("theme-default","theme-green","theme-blue","theme-red","theme-pink","theme-white"),document.body.classList.add(`theme-${t}`),chrome.storage.local.set({noctura_theme:t})}),a.addEventListener("click",()=>{let e=parseFloat(s.textContent);e>.1&&(e=Math.max(.1,e-.1),n.style.opacity=e,r&&(r.style.opacity=e),s.textContent=e.toFixed(1),chrome.storage.local.set({noctura_opacity:e}))}),i.addEventListener("click",()=>{let e=parseFloat(s.textContent);e<1&&(e=Math.min(1,e+.1),n.style.opacity=e,r&&(r.style.opacity=e),s.textContent=e.toFixed(1),chrome.storage.local.set({noctura_opacity:e}))}),l.addEventListener("input",e=>{const t=e.target.value;d(t),chrome.storage.local.set({noctura_accentColor:t})});const u=document.getElementById("discordBtn");u&&u.addEventListener("click",()=>{chrome.tabs.create({url:"https://discord.gg/b3JMDN6tCU"})})})();
let attachedTarget=null,timerInterval=null,botStartTime=null;function checkContentScriptConnection(tabId){return new Promise(resolve=>{if(!chrome.runtime?.id)return console.warn("[Noctura] Extension context invalid during connection check"),void resolve(!1);try{chrome.tabs.sendMessage(tabId,{action:"ping"},response=>{if(chrome.runtime.lastError)return console.warn("[Noctura] Content script check failed:",chrome.runtime.lastError),void resolve(!1);resolve(!0)})}catch(err){console.warn("[Noctura] Connection check error:",err),resolve(!1)}})}function startTimer(){chrome.runtime?.id?chrome.storage.local.get(["noctura_start","noctura_timerEnabled","noctura_state"],result=>{try{!1!==result.noctura_timerEnabled&&result.noctura_state?(botStartTime=result.noctura_start||Date.now(),result.noctura_start||chrome.storage.local.set({noctura_start:botStartTime,noctura_timerRunning:!0}),timerInterval&&clearInterval(timerInterval),timerInterval=setInterval(()=>{try{const elapsed=Date.now()-botStartTime;Math.floor(elapsed/1e3)%10==0&&console.log("[Noctura] Timer running:",formatTime(elapsed))}catch(err){console.warn("[Noctura] Timer interval error:",err)}},1e3),console.log("[Noctura] Timer started at:",new Date(botStartTime).toLocaleTimeString())):console.log("[Noctura] Timer not started - disabled or bot not running")}catch(err){console.error("[Noctura] Timer start error:",err)}}):console.warn("[Noctura] Cannot start timer - extension context invalid")}function stopTimer(){try{if(timerInterval&&(clearInterval(timerInterval),timerInterval=null),!chrome.runtime?.id)return void console.warn("[Noctura] Cannot access storage - extension context invalid");chrome.storage.local.get(["noctura_state","noctura_timerEnabled"],result=>{try{result.noctura_state?!1===result.noctura_timerEnabled?chrome.storage.local.set({noctura_timerRunning:!1},()=>{console.log("[Noctura] Timer paused (disabled) but preserving start time")}):console.log("[Noctura] Timer paused but keeping time"):(botStartTime=null,chrome.storage.local.remove(["noctura_start","noctura_timerRunning"]),console.log("[Noctura] Timer stopped and reset"))}catch(err){console.warn("[Noctura] Timer stop storage error:",err)}})}catch(err){console.error("[Noctura] Timer stop error:",err)}}function getTimerElapsed(){return botStartTime?Date.now()-botStartTime:0}function formatTime(ms){const seconds=Math.floor(ms/1e3);return`${Math.floor(seconds/3600).toString().padStart(2,"0")}:${Math.floor(seconds%3600/60).toString().padStart(2,"0")}:${(seconds%60).toString().padStart(2,"0")}`}function attachDebuggerOnDemand(){chrome.tabs.query({url:"*://www.wolvesville.com/*"},tabs=>{if(tabs.length>0&&!attachedTarget){const tabId=tabs[0].id;console.log("[Noctura] Found Wolvesville tab:",tabId),chrome.storage.local.set({wolf_tab_id:tabId},()=>{console.log("[Noctura] Stored tab ID"),ensureDebuggerAttached(tabId,()=>{console.log("[Noctura] Debugger attached, initializing..."),initializeTab(tabId)})})}else console.warn("[Noctura] No suitable tab found for debugger")})}function initializeTab(tabId){console.log("[Noctura] Initializing tab:",tabId);try{chrome.scripting.executeScript({target:{tabId:tabId},files:["noctura.js"]}).then(()=>{console.log("[Noctura] Full content script (noctura.js) injected successfully")}).catch(err=>{console.warn("[Noctura] Full content script injection failed, falling back to ping handler:",err);try{chrome.scripting.executeScript({target:{tabId:tabId},func:()=>{window.nocturaPingHandler||(window.nocturaPingHandler=!0,chrome.runtime.onMessage.addListener((msg,sender,sendResponse)=>{if("ping"===msg.action)return sendResponse({status:"ok"}),!0})),console.log("[Noctura] Ping handler installed (fallback)")}}).then(()=>{console.log("[Noctura] Ping handler injected as fallback")}).catch(innerErr=>{console.error("[Noctura] Fallback ping handler injection failed:",innerErr)})}catch(innerErr){console.error("[Noctura] Scripting fallback threw:",innerErr)}})}catch(e){console.error("[Noctura] initializeTab scripting.executeScript threw:",e)}}function ensureDebuggerAttached(_0x29418a,_0x380980){if(attachedTarget&&attachedTarget.tabId===_0x29418a)return _0x380980();attachedTarget={tabId:_0x29418a},chrome.debugger.attach(attachedTarget,"1.2",()=>{if(chrome.runtime.lastError)return console.warn("[Noctura] Failed to attach:",chrome.runtime.lastError.message),void(attachedTarget=null);console.log("[Noctura] Debugger attached to tab:",_0x29418a),_0x380980()})}function performClick(_0x3383a6,_0x4370ab,_0x1e92db="left"){chrome.tabs.query({url:"*://www.wolvesville.com/*"},_0xd1f5f4=>{if(!_0xd1f5f4.length)return void console.warn("[Noctura] No Wolvesville tab found");const _0x76038b=_0xd1f5f4[0].id;ensureDebuggerAttached(_0x76038b,()=>{const _0x394c9f={tabId:_0x76038b},_0x3e6941=_0x3cadfe=>chrome.debugger.sendCommand(_0x394c9f,"Input.dispatchMouseEvent",{type:_0x3cadfe,button:_0x1e92db,x:_0x3383a6,y:_0x4370ab,clickCount:1});_0x3e6941("mouseMoved"),_0x3e6941("mousePressed"),_0x3e6941("mouseReleased")})})}chrome.storage.local.get(["noctura_state","noctura_start","noctura_timerEnabled","noctura_timerRunning","noctura_auto_restart_allowed"],result=>{try{const allowAuto=!!result.noctura_auto_restart_allowed;allowAuto&&!1!==result.noctura_timerEnabled&&result.noctura_start&&result.noctura_timerRunning?(console.log("[Noctura] Restoring active timer state"),botStartTime=result.noctura_start,startTimer()):(console.log("[Noctura] No active timer found - cleaning up state"),botStartTime=null,chrome.storage.local.remove(["noctura_timerRunning"])),result.noctura_state&&!allowAuto?(console.log("[Noctura] Previous bot state was running but auto-restart is disabled - clearing running state"),chrome.storage.local.set({noctura_state:!1},()=>{chrome.storage.local.remove(["noctura_start","noctura_timerRunning","_noctura_prev_start_tmp"])})):result.noctura_state&&allowAuto&&console.log("[Noctura] Preserving existing bot state (running)")}catch(err){console.error("[Noctura] State restoration error:",err),botStartTime=null,chrome.storage.local.remove(["noctura_timerRunning"])}}),chrome.storage.local.get(["noctura_state","noctura_start","noctura_timerEnabled","noctura_timerRunning","noctura_auto_restart_allowed"],result=>{const allowAuto=!!result.noctura_auto_restart_allowed;allowAuto&&!1!==result.noctura_timerEnabled&&result.noctura_start&&result.noctura_timerRunning?(console.log("[Noctura] Restoring previous timer state"),botStartTime=result.noctura_start,startTimer()):(botStartTime=null,chrome.storage.local.remove(["noctura_start","noctura_timerRunning"]),console.log("[Noctura] Cleared previous timer state")),result.noctura_state&&!allowAuto?(console.log("[Noctura] Previous bot state was running but auto-restart is disabled - clearing running state"),chrome.storage.local.set({noctura_state:!1},()=>{chrome.storage.local.remove(["noctura_start","noctura_timerRunning","_noctura_prev_start_tmp"])})):result.noctura_state&&allowAuto&&console.log("[Noctura] Previous bot state was running - maintaining state")}),chrome.debugger.onDetach.addListener((source,reason)=>{console.warn("[Noctura] Debugger detached:",reason),attachedTarget&&source.tabId===attachedTarget.tabId&&(attachedTarget=null,console.log("[Noctura] Waiting for reattach"))}),chrome.tabs.onUpdated.addListener((tabId,changeInfo,tab)=>{if("loading"===changeInfo.status&&tab.url?.includes("wolvesville.com")&&attachedTarget&&attachedTarget.tabId===tabId){try{chrome.debugger.detach(attachedTarget,()=>{console.log("[Noctura] Debugger detached due to tab reload/navigation")})}catch(err){console.warn("[Noctura] Error detaching debugger on reload:",err)}attachedTarget=null}"complete"===changeInfo.status&&tab.url?.includes("wolvesville.com")&&(console.log("[Noctura] Wolvesville tab detected, starting initialization..."),chrome.storage.local.set({wolf_tab_id:tabId},()=>{chrome.storage.local.get(["noctura_state","noctura_auto_restart_allowed"],result=>{const allowAuto=!!result.noctura_auto_restart_allowed;result.noctura_state?allowAuto?(console.log("[Noctura] Bot was running and auto-restart allowed - initializing tab and reattaching debugger"),initializeTab(tabId),setTimeout(()=>{attachedTarget||(console.log("[Noctura] Reattaching debugger..."),attachDebuggerOnDemand())},1500)):(console.log("[Noctura] Tab reload detected but auto-restart disabled - clearing running state"),chrome.storage.local.set({noctura_state:!1},()=>{chrome.storage.local.remove(["noctura_start","noctura_timerRunning","_noctura_prev_start_tmp"])}),initializeTab(tabId)):initializeTab(tabId)})}))}),chrome.runtime.onStartup.addListener(()=>{console.log("[Noctura] Extension started - ensuring bot does not auto-start"),chrome.storage.local.get(["noctura_auto_restart_allowed"],res=>{try{res.noctura_auto_restart_allowed?console.log("[Noctura] Auto-restart allowed - preserving stored state"):chrome.storage.local.get(["noctura_state","noctura_start"],prev=>{try{prev.noctura_state?(console.log("[Noctura] Auto-restart disabled - clearing previous running state"),chrome.storage.local.set({noctura_state:!1},()=>{chrome.storage.local.remove(["noctura_start","noctura_timerRunning","_noctura_prev_start_tmp"])})):(chrome.storage.local.remove(["noctura_start","noctura_timerRunning"]),console.log("[Noctura] Auto-start disabled - no previous running session to restore"))}catch(innerErr){console.warn("[Noctura] onStartup prev-state check error:",innerErr)}})}catch(err){console.warn("[Noctura] onStartup handler error:",err)}})}),chrome.runtime.onInstalled.addListener(()=>{console.log("[Noctura] Extension installed/updated")}),chrome.runtime.onMessage.addListener((_0x3df747,_0x4e302e,_0x3f94ab)=>{if("performClick"===_0x3df747.action)return chrome.tabs.query({url:"*://www.wolvesville.com/*"},tabs=>{tabs.length>0&&(performClick(_0x3df747.x,_0x3df747.y,_0x3df747.button),"function"==typeof _0x3f94ab&&_0x3f94ab({ok:!0}))}),!0;if("startTimer"===_0x3df747.action)return startTimer(),"function"==typeof _0x3f94ab&&_0x3f94ab({ok:!0}),!0;if("stopTimer"===_0x3df747.action)return stopTimer(),"function"==typeof _0x3f94ab&&_0x3f94ab({ok:!0}),!0;if("startDebugger"===_0x3df747.action)return chrome.storage.local.get(["wolf_tab_id"],result=>{result.wolf_tab_id?(initializeTab(result.wolf_tab_id),setTimeout(()=>{attachDebuggerOnDemand(),"function"==typeof _0x3f94ab&&_0x3f94ab({ok:!0})},500)):(attachDebuggerOnDemand(),"function"==typeof _0x3f94ab&&_0x3f94ab({ok:!0}))}),!0;if("stopDebugger"===_0x3df747.action)return attachedTarget?chrome.debugger.detach(attachedTarget,()=>{attachedTarget=null,"function"==typeof _0x3f94ab&&_0x3f94ab({ok:!0})}):"function"==typeof _0x3f94ab&&_0x3f94ab({ok:!0}),!0;if("getTimerState"===_0x3df747.action){try{const elapsed=getTimerElapsed(),response={elapsed:elapsed,formatted:formatTime(elapsed),startTime:botStartTime};"function"==typeof _0x3f94ab&&_0x3f94ab(response)}catch(error){console.error("[Noctura] Timer state error:",error),"function"==typeof _0x3f94ab&&_0x3f94ab({error:error.message,formatted:"00:00:00"})}return!0}return"function"==typeof _0x3f94ab&&_0x3f94ab({error:"Unknown action"}),!0}),chrome.runtime.onSuspend.addListener(()=>{attachedTarget&&(chrome.debugger.detach(attachedTarget),attachedTarget=null)});
let attachedTarget=null,timerInterval=null,botStartTime=null;function startTimer(){chrome.storage.local.get(["noctura_start"],t=>{botStartTime=t.noctura_start||Date.now(),t.noctura_start||chrome.storage.local.set({noctura_start:botStartTime}),timerInterval&&clearInterval(timerInterval),timerInterval=setInterval(()=>{const t=Date.now()-botStartTime;Math.floor(t/1e3)%10==0&&console.log("[Noctura] Timer running:",formatTime(t))},1e3),console.log("[Noctura] Timer started at:",new Date(botStartTime).toLocaleTimeString())})}function stopTimer(){timerInterval&&(clearInterval(timerInterval),timerInterval=null),botStartTime=null,chrome.storage.local.remove("noctura_start"),console.log("[Noctura] Timer stopped")}function getTimerElapsed(){return botStartTime?Date.now()-botStartTime:0}function formatTime(t){const e=Math.floor(t/1e3);return`${Math.floor(e/3600).toString().padStart(2,"0")}:${Math.floor(e%3600/60).toString().padStart(2,"0")}:${(e%60).toString().padStart(2,"0")}`}function attachDebuggerOnDemand(){chrome.tabs.query({url:"*://www.wolvesville.com/*"},t=>{if(t.length>0&&!attachedTarget){const e=t[0].id;console.log("[Noctura] Attaching debugger to tab:",e),ensureDebuggerAttached(e,()=>{console.log("[Noctura] Debugger ready")})}})}function ensureDebuggerAttached(t,e){if(attachedTarget&&attachedTarget.tabId===t)return e();attachedTarget={tabId:t},chrome.debugger.attach(attachedTarget,"1.2",()=>{if(chrome.runtime.lastError)return console.warn("[Noctura] Failed to attach:",chrome.runtime.lastError.message),void(attachedTarget=null);console.log("[Noctura] Debugger attached to tab:",t),e()})}function performClick(t,e,r="left"){chrome.tabs.query({url:"*://www.wolvesville.com/*"},a=>{if(!a.length)return void console.warn("[Noctura] No Wolvesville tab found");const o=a[0].id;ensureDebuggerAttached(o,()=>{const a={tabId:o},n=o=>chrome.debugger.sendCommand(a,"Input.dispatchMouseEvent",{type:o,button:r,x:t,y:e,clickCount:1});n("mouseMoved"),n("mousePressed"),n("mouseReleased")})})}chrome.storage.local.get(["noctura_state","noctura_start"],t=>{t.noctura_state&&t.noctura_start&&(console.log("[Noctura] Previous bot session detected"),chrome.storage.local.set({noctura_state:!1}))}),chrome.debugger.onDetach.addListener((t,e)=>{console.warn("[Noctura] Debugger detached:",e),attachedTarget&&t.tabId===attachedTarget.tabId&&(attachedTarget=null,console.log("[Noctura] Waiting for reattach"))}),chrome.tabs.onUpdated.addListener((t,e,r)=>{"complete"===e.status&&r.url?.includes("wolvesville.com")&&console.log("[Noctura] Wolvesville tab detected")}),chrome.runtime.onStartup.addListener(()=>{console.log("[Noctura] Extension started")}),chrome.runtime.onInstalled.addListener(()=>{console.log("[Noctura] Extension installed/updated")}),chrome.runtime.onMessage.addListener((t,e,r)=>{try{if("performClick"===t.action)return performClick(t.x,t.y,t.button),"function"==typeof r&&r({ok:!0}),!0;if("startTimer"===t.action)return attachDebuggerOnDemand(),startTimer(),"function"==typeof r&&r({ok:!0}),!0;if("stopTimer"===t.action)return stopTimer(),attachedTarget&&chrome.debugger.detach(attachedTarget,()=>{attachedTarget=null}),"function"==typeof r&&r({ok:!0}),!0;if("getTimerState"===t.action){try{const t=getTimerElapsed(),e={elapsed:t,formatted:formatTime(t),startTime:botStartTime};"function"==typeof r&&r(e)}catch(t){"function"==typeof r&&r({error:t.message,formatted:"00:00:00"})}return!0}}catch(t){return"function"==typeof r&&r({error:t.message}),!0}return!0}),chrome.runtime.onSuspend.addListener(()=>{attachedTarget&&(chrome.debugger.detach(attachedTarget),attachedTarget=null)});
let nicknameCache={value:null,timestamp:0,cacheExpireMs:3e4},processedVoteMessages=new Set;function removeSymbolsFromNickname(e){if(!e)return"";let t=String(e).trim();return t.includes("|")?(t=t.split("|").pop().trim(),console.log(`[Noctura] Cleaned nickname from "${e}" â†’ "${t}"`)):console.log(`[Noctura] Normalizing nickname without separator: "${e}"`),t=t.normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9_.-]/g,"").trim(),t||console.warn(`[Noctura] Sanitization removed every character from "${e}"`),t}function extractCurrentWolvesvilleNickname(){try{const e=Date.now();if(nicknameCache.value&&e-nicknameCache.timestamp<nicknameCache.cacheExpireMs)return console.log("[Noctura] Using cached nickname:",nicknameCache.value),nicknameCache.value;console.log("[Noctura] Starting OPTIMIZED nickname extraction from Wolvesville...");const t=new Set(["Menu","Home","Play","Settings","Profile","Friends","Start","Stop","Continue","Back","Next","Previous","Yes","No","OK","Cancel","Login","Register","Loading","Game","Lobby","Chat","Vote","Day","Night","Voting","Werewolf","Villager","Role","Team","Dead","Alive","Join","Leave","Ready","Waiting","Players","Required","Store","Shop","Market","Collection","News","Updates","Inventory","Inbox","Notifications","Achievements","Quests","Wolvesville","Noctura","Season","Leaderboard","Ranked"].map(e=>e.toLowerCase())),o=e=>"string"==typeof e&&t.has(e.toLowerCase()),n=e=>{if(!e)return!1;const t=e.length;return!(t<2||t>20)&&(!/^\d+$/.test(e)&&(!/^[_-]+$/.test(e)&&!!/[a-zA-Z]/.test(e)))};console.log("[Noctura] Method 0 (PRIORITY): Looking in header top-right...");const l=document.querySelectorAll('div[dir="auto"]');for(const e of l){const t=e.textContent?.trim();if(t&&t.includes("|")){const l=e.getBoundingClientRect();if(l.top<200&&l.left>.5*window.innerWidth){const e=t.split("|");if(e.length>=2){const r=e[e.length-1].trim();if(r&&r.length>=2&&r.length<=30&&/^[a-zA-Z0-9_-]+$/.test(r)&&!o(r)){const e=removeSymbolsFromNickname(t);if(n(e))return console.log("[Noctura] âœ… FOUND in header top-right:",t),console.log("[Noctura] Position:",`top=${l.top}px, left=${l.left}px`),console.log("[Noctura] Clean nickname:",e),nicknameCache.value=e,nicknameCache.timestamp=Date.now(),e}}}}}console.log("[Noctura] âš ï¸ Header top-right method failed, trying other methods..."),console.log("[Noctura] Method 1 OPTIMIZED: Looking for pipe-separated nicknames...");const r=['div[class*="player"]','span[class*="player"]','div[class*="name"]','span[class*="name"]',".username",".nickname",'[data-testid*="name"]'];for(const e of r)try{const t=document.querySelectorAll(e);for(const e of t){const t=e.textContent?.trim();if(t&&t.includes("|")){const e=t.split("|");if(e.length>=2){const l=e[e.length-1].trim();if(l&&l.length>=2&&l.length<=30&&/^[a-zA-Z0-9_-]+$/.test(l)&&!o(l)){const e=removeSymbolsFromNickname(t);if(n(e)&&!o(e))return console.log("[Noctura] QUICK FIND - Found pipe-separated nickname:",t),console.log("[Noctura] Clean nickname after symbol processing:",e),nicknameCache.value=e,nicknameCache.timestamp=Date.now(),e}}}}}catch(t){console.log("[Noctura] Skipped invalid selector:",e)}console.log("[Noctura] Fallback: Using limited DOM query...");const i=document.querySelectorAll("div, span, p, a");for(const e of i){const t=e.textContent?.trim();if(t&&t.includes("|")){const e=t.split("|");if(e.length>=2){const l=e[e.length-1].trim();if(l&&l.length>=2&&l.length<=30&&/^[a-zA-Z0-9_-]+$/.test(l)&&!o(l)){const e=removeSymbolsFromNickname(t);if(n(e)&&!o(e))return console.log("[Noctura] Fallback - Found pipe-separated nickname:",t),console.log("[Noctura] Clean nickname after symbol processing:",e),nicknameCache.value=e,nicknameCache.timestamp=Date.now(),e}}}}console.log("[Noctura] Method 2: Looking for current player indicators...");const c=['*[class*="current"]','*[class*="active"]','*[class*="self"]','*[class*="me"]','*[class*="you"]','*[class*="selected"]','*[data-current="true"]','*[data-active="true"]'];for(const e of c)try{const t=document.querySelectorAll(e);for(const e of t){const t=e.textContent?.trim();if(t&&t.length>=2&&t.length<=30){let e=t;if(t.includes("|")&&(e=t.split("|").pop().trim()),e&&/^[a-zA-Z0-9_-]+$/.test(e)&&!o(e)){console.log("[Noctura] Found nickname in current player element (raw):",t);const e=removeSymbolsFromNickname(t);if(n(e)&&!o(e))return console.log("[Noctura] Clean nickname after symbol processing:",e),e}}}}catch(t){console.log("[Noctura] Skipped invalid selector:",e)}console.log("[Noctura] Method 3: Looking in player lists...");const a=document.querySelectorAll('div[class*="player"], div[class*="participants"] span, .game-players span, div[class*="Player"], span[class*="Player"]');for(const e of a){const t=e.textContent?.trim();if(t&&t.length>=2&&t.length<=30&&!t.includes("Role:")&&!t.includes("Dead")&&!t.includes("Alive")){let l=t;if(t.includes("|")&&(l=t.split("|").pop().trim()),l&&l.length>=2&&l.length<=30&&/^[a-zA-Z0-9_-]+$/.test(l)&&!o(l)){const l=e.closest("div");if(l&&(l.classList.toString().includes("selected")||l.classList.toString().includes("current")||l.classList.toString().includes("active")||l.classList.toString().includes("me"))){console.log("[Noctura] ðŸ” Found my nickname in player list (raw):",t);const e=removeSymbolsFromNickname(t);if(n(e)&&!o(e))return console.log("[Noctura] ðŸ” Clean nickname after symbol processing:",e),e}}}}console.log("[Noctura] Method 4: Trying Wolvesville-specific selectors...");const s=['div[class*="name"]','span[class*="player"]','div[class*="user"]',".player-name",".username",".nickname",'[data-testid*="player"]','[data-testid*="name"]','*[class*="Player"]','*[class*="NAME"]','*[class*="Nick"]'];for(const e of s)try{const t=document.querySelectorAll(e);for(const e of t){const t=e.textContent?.trim();if(!t)continue;let l=t;if(t.includes("|")&&(l=t.split("|").pop().trim()),l&&l.length>=2&&l.length<=30&&/^[a-zA-Z0-9_-]+$/.test(l)&&!o(l)){const l=e.closest("div, section, article"),r=l?l.textContent.toLowerCase():"";if(r.includes("you")||r.includes("current")||r.includes("player")||e.classList.toString().includes("current")||e.classList.toString().includes("active")||e.classList.toString().includes("self")){console.log("[Noctura] Found nickname in Wolvesville-specific element (raw):",t);const e=removeSymbolsFromNickname(t);if(n(e)&&!o(e))return console.log("[Noctura] Clean nickname after symbol processing:",e),e}}}}catch(t){console.log("[Noctura] Skipped invalid selector:",e)}console.log("[Noctura] Method 5: Looking in menu/header elements...");const u=document.querySelectorAll("header *, nav *, .header *, .menu *, .user-info *");for(const e of u){const t=e.textContent?.trim();if(t&&t.length>=2&&t.length<=30){let l=t;if(t.includes("|")&&(l=t.split("|").pop().trim()),l&&!l.includes("Menu")&&!l.includes("Settings")&&!l.includes("Home")&&!l.includes("Play")&&!l.includes("Profile")&&!l.includes("Friends")&&/^[a-zA-Z0-9_-]+$/.test(l)&&!o(l)){const l=e.parentElement?.textContent||"";if(l.toLowerCase().includes("welcome")||l.toLowerCase().includes("hello")||e.className.includes("user")||e.className.includes("profile")){console.log("[Noctura] Found potential nickname in menu (raw):",t);const e=removeSymbolsFromNickname(t);if(n(e)&&!o(e))return console.log("[Noctura] Clean nickname after symbol processing:",e),e}}}}console.log("[Noctura] Method 6: Checking URL for nickname...");const m=window.location.href,d=[/\/profile\/([^\/?&]+)/,/\/player\/([^\/?&]+)/,/\/user\/([^\/?&]+)/,/username=([^&]+)/,/player=([^&]+)/,/nick=([^&]+)/,/name=([^&]+)/];for(const e of d){const t=m.match(e);if(t&&t[1]){let e=decodeURIComponent(t[1]);if(e.includes("|")&&(e=e.split("|").pop().trim()),e&&/^[a-zA-Z0-9_.-]+$/.test(e)&&!o(e)){console.log("[Noctura] Found nickname in URL (raw):",t[1]);const e=removeSymbolsFromNickname(t[1]);if(n(e)&&!o(e))return console.log("[Noctura] Clean nickname after symbol processing:",e),e}}}console.log("[Noctura] Method 7: Checking game data objects...");try{if(window.gameData&&window.gameData.currentPlayer){const e=window.gameData.currentPlayer.name||window.gameData.currentPlayer.nickname;if(e&&!o(e)){console.log("[Noctura] Found nickname in gameData (raw):",e);const t=removeSymbolsFromNickname(e);if(n(t)&&!o(t))return console.log("[Noctura] Clean nickname after symbol processing:",t),t}}if(window.playerData){const e=window.playerData.name||window.playerData.nickname||window.playerData.username;if(e&&!o(e)){console.log("[Noctura] Found nickname in playerData (raw):",e);const t=removeSymbolsFromNickname(e);if(n(t)&&!o(t))return console.log("[Noctura] Clean nickname after symbol processing:",t),t}}}catch(e){console.log("[Noctura] No game data objects found")}console.log("[Noctura] Method 8 OPTIMIZED: Enhanced fallback method...");const f=[];for(const e of i){const t=e.textContent?.trim();if(!t)continue;let n=[t];t.includes("|")&&n.push(t.split("|").pop().trim());for(const e of n)if(e&&e.length>=2&&e.length<=30&&!e.includes(" ")&&!e.includes("\n")&&!e.includes("\t")&&/^[a-zA-Z0-9_.-]+$/.test(e)&&!o(e)&&!e.match(/^\d+$/)&&!e.match(/^[_\.-]+$/)&&e.match(/[a-zA-Z]/)){const o=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),n=new RegExp(`\\b${o}\\b`,"g"),l=document.body?.textContent?.match(n),r=l?l.length:0;if(r>=1&&r<=15){let o=0;const n=document.body?.textContent?.toLowerCase()||"";(n.includes(e.toLowerCase()+" is")||n.includes("player "+e.toLowerCase())||n.includes(e.toLowerCase()+" voted")||n.includes("welcome "+e.toLowerCase())||n.includes(e.toLowerCase()+" joined")||n.includes("you are "+e.toLowerCase()))&&(o+=5),t.includes("|")&&t.includes(e)&&(o+=3),f.push({text:e,originalText:t,count:r,contextScore:o,totalScore:r+o})}}}if(f.length>0){f.sort((e,t)=>t.totalScore-e.totalScore),console.log("[Noctura] All potential nicknames found (top 5):",f.slice(0,5));const e=f[0];console.log("[Noctura] Best candidate nickname (raw):",e.originalText,`(appears ${e.count} times, context score: ${e.contextScore})`);const t=removeSymbolsFromNickname(e.originalText);return console.log("[Noctura] Final clean nickname:",t),t}return console.warn("[Noctura] Could not extract nickname from Wolvesville using any method"),null}catch(e){return console.error("[Noctura] Error extracting nickname:",e),null}}function verifyNicknameMatch(e,t){if(!e||!t)return console.warn("[Noctura] Missing nickname data for verification"),console.warn("[Noctura] Bot nickname:",e),console.warn("[Noctura] Site nickname:",t),!1;const o=removeSymbolsFromNickname(e),n=removeSymbolsFromNickname(t),l=o.toLowerCase().trim(),r=n.toLowerCase().trim(),i=l===r;return console.log("[Noctura] Nickname Verification (Enhanced):"),console.log("[Noctura] Bot configured for:",e,"â†’ cleaned:",o),console.log("[Noctura] Current Wolvesville user:",t,"â†’ cleaned:",n),console.log("[Noctura] Normalized comparison:",l,"===",r),console.log("[Noctura] Match result:",i?"VERIFIED":"MISMATCH"),i||(console.log("[Noctura] Debug info:"),console.log("[Noctura] - Bot name length:",l.length),console.log("[Noctura] - Site name length:",r.length),console.log("[Noctura] - Character difference:",Array.from(l).map((e,t)=>e===r[t]?"âœ“":`X(${e} vs ${r[t]||"END"})`))),i}function displaySecurityAlert(e,t){const o=document.createElement("div");o.style.cssText="\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background: rgba(139, 0, 0, 0.95);\n    color: white;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    z-index: 10000;\n    font-family: Arial, sans-serif;\n    font-size: 18px;\n  ",o.innerHTML=`\n    <div style="text-align: center; padding: 40px; background: #8B0000; border: 3px solid #FF4444; border-radius: 15px; max-width: 600px;">\n      <h2 style="color: #FFD700; margin-bottom: 20px;">ðŸš« SECURITY: ACCESS DENIED</h2>\n      <p style="margin-bottom: 15px;"><strong>The bot has been blocked for security reasons.</strong></p>\n      <p style="margin-bottom: 10px;">Bot configured for: <strong>${e}</strong></p>\n      <p style="margin-bottom: 15px;">Detected Wolvesville user: <strong>${t||"Not detected"}</strong></p>\n      <p style="font-size: 12px; color: #FFAAAA; margin-bottom: 20px;">(Symbol prefixes like 'âšš|' are automatically excluded from comparison)</p>\n      <p style="font-size: 14px; color: #FFAAAA;">The bot can only be used by the authorized owner.</p>\n      <button onclick="this.parentElement.parentElement.remove()" \n              style="margin-top: 20px; padding: 10px 20px; background: #444; color: white; border: none; cursor: pointer; border-radius: 5px;">\n        Close this warning\n      </button>\n    </div>\n  `,document.body.appendChild(o),setTimeout(()=>{o.parentElement&&o.remove()},3e4)}function click(e,t="left"){const o=e.getBoundingClientRect(),n=o.left+o.width/2,l=o.top+o.height/2;console.log("[Noctura] Request click @",n,l,"â†’",e.textContent.trim()),chrome.runtime.sendMessage({action:"performClick",x:n,y:l,button:t},e=>{chrome.runtime.lastError?console.error("[Noctura] sendMessage error:",chrome.runtime.lastError.message):console.log("[Noctura] BG responded:",e)})}function isVisible(e){const t=window.getComputedStyle(e);return null!==e.offsetParent&&e.offsetWidth>0&&e.offsetHeight>0&&"hidden"!==t.visibility&&"none"!==t.display&&e.getClientRects().length>0}function waitForTextInDOM(e,{timeout:t=3e4,interval:o=200,cancelText:n=null}={}){return waitForCondition(()=>{for(const t of document.body.querySelectorAll("*"))if(t.textContent.includes(e)&&isVisible(t))return t},t,o,n)}function waitForExactText(e,{timeout:t=3e4,interval:o=200,cancelText:n=null}={}){const l=new RegExp("\\b"+e+"\\b");return waitForCondition(()=>{for(const e of document.body.querySelectorAll("*"))if(l.test(e.textContent)&&isVisible(e))return e},t,o,n)}function waitForImageInDOM(e,{timeout:t=3e4,interval:o=200,cancelText:n=null}={}){return waitForCondition(()=>{for(const t of document.images)if(t.src.includes(e)&&isVisible(t))return t},t,o,n)}function waitForImageCountInDOM(e,t=2,{timeout:o=3e4,interval:n=200,cancelText:l=null}={}){return waitForCondition(()=>{const o=[];for(const n of document.images)if(n.src.includes(e)&&isVisible(n)&&o.push(n),o.length>=t)return o},o,n,l)}function waitForCondition(e,t,o,n){return new Promise(l=>{const r=Date.now(),i=()=>{const c=e();return c?l(c):n&&document.body.innerText.includes(n)||Date.now()-r>=t?l(null):void setTimeout(i,o)};i()})}function sleep(e){return new Promise(t=>setTimeout(t,e))}async function clickAndVerifyDisappear(e,t,o=3){for(let n=0;n<o;n++){const o=t();if(!o)break;click(o),await sleep(300);if(!Array.from(document.querySelectorAll("*")).some(t=>t.textContent.includes(e)&&isVisible(t)))break}}function clickElementByImage(e){const t=Array.from(document.querySelectorAll('[tabindex="0"]')).find(t=>Array.from(t.querySelectorAll("img")).some(t=>e.test(t.src))&&!t.disabled);t&&click(t)}function clickElementByImageInElement(e,t){const o=Array.from(e.querySelectorAll("img")).find(e=>t.test(e.src));if(o){const e=o.closest('[tabindex="0"]');e&&!e.disabled&&click(e)}}function clickElementByText(e){const t=Array.from(document.querySelectorAll('[tabindex="0"]')).find(t=>t.textContent.includes(e)&&!t.disabled);t&&click(t)}function clickInnermostElementByImage(e){const t=Array.from(document.querySelectorAll('[tabindex="0"]')).filter(t=>Array.from(t.querySelectorAll("img")).some(t=>t.src.includes(e))&&!t.disabled);if(0===t.length)return;let o=t[0],n=0;for(const e of t){let t=0,l=e.parentElement;for(;l;)t++,l=l.parentElement;t>n&&(n=t,o=e)}click(o)}function clickInnermostElementByText(e){const t=Array.from(document.querySelectorAll('[tabindex="0"]')).filter(t=>t.textContent.includes(e)&&!t.disabled);if(0===t.length)return;let o=t[0],n=0;t.forEach(e=>{let t=0,l=e.parentElement;for(;l;)t++,l=l.parentElement;t>n&&(n=t,o=e)}),click(o)}function clickOutermostElement(e){const t=Array.from(e.querySelectorAll('[tabindex="0"]')).filter(e=>!e.disabled);if(0===t.length)return;let o=t[0],n=1/0;t.forEach(t=>{let l=0,r=t.parentElement;for(;r&&r!==e;)l++,r=r.parentElement;l<n&&(n=l,o=t)}),click(o)}function findImageInDocument(e){return Array.from(document.querySelectorAll("img")).some(t=>t.src.includes(e))}function findImageInElement(e,t){return Array.from(e.querySelectorAll("img")).some(e=>t.test(e.src))}function findTextInDocument(e){return document.body.textContent.includes(e)}function getMessages(){let e=[],t=1/0;return document.querySelectorAll("span").forEach(o=>{if(o.textContent.includes(":")){let n=o.closest("div");if(n){let l=n.getBoundingClientRect().width*n.getBoundingClientRect().height;l<t?(t=l,e=[{div:n,spanText:o.textContent}]):l===t&&e.push({div:n,spanText:o.textContent})}}}),e.length>0?e.map(({div:e,spanText:t})=>{const o=t.match(/^(\d+)\s*:/);return{playerNumber:o?o[1]:null,text:e.textContent.replace(t,"").trim(),fullText:e.textContent.trim()}}):null}function getPlayerRole(e){if(!e)return"Unknown";let t="Other";const o={juniorwerewolf:"Junior Werewolf",junior_werewolf:"Junior Werewolf",split_wolf:"Split Wolf",splitwolf:"Split Wolf",wolf:"Wolf",priest:"Priest",vigilante:"Shooter",gunner:"Shooter"};for(const n of Object.keys(o))if(e.includes(n)){t=o[n];break}return t}async function shooterAction(e,t,o,n=2){if(console.log("[Noctura] shooterAction: looking for",n,"vote marker(s)"),n>4)return;const l=await waitForImageCountInDOM("vote_day_selected",n,{timeout:9e4,cancelText:"Continue"});if(gameIsOver())return;if(!l)return void console.warn("[Noctura] ðŸ›‘ Shooter/Priest: No vote markers found, NOT using ability");console.log("[Noctura] Clicking bullet icon..."),clickElementByImage(/.*gunner_bullet.*\.png/),await sleep(200);const r=o.find(o=>findImageInElement(o,new RegExp(".*vote_day_selected.*\\.png"))&&!t.includes(o)&&!o.textContent.includes(e.name));if(r)return console.log("[Noctura] Shooter found target:",r?.textContent.trim()),void clickElementByImageInElement(r,/.*gunner_voting_shoot.*\.png/);await sleep(500),await shooterAction(e,t,o,n+1)}async function inGameDay(e,t,o,n){if(!gameIsOver()){if(console.log("[Noctura] inGameDay(): role =",e.role,"| Lovers =",t.map(e=>e?.textContent.trim())),wolfSet.has(e.role)){let t=getMessages()?.flatMap(e=>(e?.fullText||e).match(/\b\d{1,2}\b/g)||[]);if(t?.some(t=>t==e.number))return void console.log("[Noctura] Wolf number already in chat, skipping");if(gameIsOver())return;console.log("[Noctura] ðŸº Wolf sending number:",e.number);let o=document.querySelector("textarea");return Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value").set.call(o,e.number),o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0})),clickElementByImage(/.*icon_send.*\.png/),void sleep(1e3)}if(wolfSet.has(e.coupleRole1)||wolfSet.has(e.coupleRole2)){if(!o.some(e=>e.some(e=>e.includes("hand-skin")))){let t=null;if(e.coupleNumber1&&e.coupleNumber1!==e.number?t=e.coupleNumber1:e.coupleNumber2&&e.coupleNumber2!==e.number&&(t=e.coupleNumber2),t){console.log("[Noctura] ðŸ’‘ VOTING LOVER IN COUPLE: Player #"+t+" (role: "+(e.coupleRole1===t.toString()?e.coupleRole1:e.coupleRole2)+")");const o=n.find(e=>e.textContent.trim().startsWith(t+" "));o?(clickOutermostElement(o),console.log("[Noctura] âœ… Successfully voted lover #"+t)):console.warn("[Noctura] âš ï¸ Could not find lover player element #"+t)}else console.warn("[Noctura] âš ï¸ Could not determine lover number in couple")}"Priest"===e.role?(console.log("[Noctura] Role ability triggered:",e.role),clickElementByImage(/.*priest_holy_water.*\.png/),setTimeout(()=>{const e=n.find(e=>findImageInElement(e,/.*priest_holy_water.*\.png/));e&&clickElementByImageInElement(e,/.*priest_holy_water.*\.png/)},200)):"Shooter"===e.role&&await shooterAction(e,t,n)}else{const t=getMessages();let o=!1;if(t&&t.length>0){for(let l=t.length-1;l>=0;l--){const r=t[l];if(processedVoteMessages.has(r.fullText))continue;let i=null,c="";const a=r.text.trim().toLowerCase();if("me"===a||"m"===a||"wc"===a)i=r.playerNumber,c="keyword '"+r.text+"' from player "+r.playerNumber,console.log("[Noctura] AutoVote: Matched keyword - cleaned text: '"+a+"', player: "+r.playerNumber);else{const e=parseInt(r.text);!isNaN(e)&&e>=1&&e<=16&&(i=e.toString(),c="direct number '"+e+"' from player "+r.playerNumber)}if(i){if(i===e.number){console.log("[Noctura] AutoVote: Skipping - cannot vote for self (player "+i+")");continue}const t=n.find(e=>e.textContent.trim().startsWith(i+" "));if(t){console.log("[Noctura] AutoVote: "+c+" â†’ voting player "+i),clickOutermostElement(t),processedVoteMessages.add(r.fullText),await sleep(500),o=!0;break}}}}if(!o&&!wolfSet.has(e.role)){console.log("[Noctura] AutoVote: No vote from messages, searching for default wolf target...");for(let t=0;t<n.length;t++){const l=n[t],r=l.textContent.trim();if(r.startsWith(e.number+" "))continue;const i=l.querySelectorAll("img");let c=null;for(const e of i){const t=e.src;if(-1===t.indexOf("vote_day")&&-1===t.indexOf("vote_werewolves")&&-1===t.indexOf("hand-skin")){c=getPlayerRole(t.slice(t.lastIndexOf("/")+1));break}}if(c&&wolfSet.has(c)){console.log("[Noctura] AutoVote: Voting default wolf target: player "+r.split(" ")[0]+" ("+c+")"),clickOutermostElement(l),o=!0;break}}}o||console.log("[Noctura] AutoVote: Could not find a target to vote");const l={Priest:{triggerRegex:/.*priest_holy_water.*\.png/,actionRegex:/.*priest_holy_water.*\.png/},Shooter:{triggerRegex:/.*gunner_bullet.*\.png/,actionRegex:/.*gunner_voting_shoot.*\.png/}}[e.role];if(l){if(await waitForImageInDOM("vote_day_selected",{timeout:9e4,cancelText:"Continue"}),gameIsOver())return;console.log("[Noctura] Role ability triggered:",e.role),clickElementByImage(l.triggerRegex),await sleep(200);const t=n.find(e=>findImageInElement(e,/.*vote_day_selected.*\.png/));t&&clickElementByImageInElement(t,l.actionRegex)}}}}async function inGameNight(e,t,o){if(gameIsOver())return;console.log("[Noctura] inGameNight(): role =",e.role);const n=(t,o)=>{if(gameIsOver())return;console.log("[Noctura] sendAction:",t,"| Target:",o?.textContent.trim());const n=document.querySelector("textarea");Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value").set.call(n,t),n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),clickElementByImage(/.*icon_send.*\.png/),o&&("Priest"!==e.coupleRole1&&"Priest"!==e.coupleRole2||"Junior Werewolf"===e.role)&&clickOutermostElement(o)},l=async l=>{if(wolfSet.has(e.coupleRole1)&&wolfSet.has(e.coupleRole2)||wolfSet.has(e.coupleRole1)&&null===e.coupleRole2)return;if(gameIsOver())return;if(console.log("[Noctura] handleWolfTag() triggered for:",e.role),await waitForTextInDOM("25s",{cancelText:"Continue"}),gameIsOver()||findTextInDocument("Voting"))return;const r=!wolfSet.has(e.coupleRole1);n("Who? Mine "+(r?e.coupleNumber1:e.coupleNumber2),r?t[0]:t[1]),await waitForExactText("5s",{cancelText:"Continue"}),gameIsOver()||findTextInDocument("Voting")||(clickElementByImage(l),setTimeout(()=>{const t=getMessages(),n=t?.flatMap(t=>((t.text||t).match(/\b\d{1,2}\b/g)||[]).filter(o=>![e.number,e.coupleNumber1,e.coupleNumber2,t.playerNumber].includes(o)))[0];if(!n)return;console.log("[Noctura] Target number chosen:",n);const r=[...o[parseInt(n,10)-1].querySelectorAll("img")].find(e=>l.test(e.src)),i=r?.closest('[tabindex="0"]:not([disabled])');i&&click(i)},200),await waitForTextInDOM("Voting",{cancelText:"Continue"}))};if("Wolf"===e.role){if(await waitForTextInDOM("25s",{cancelText:"Continue"}),gameIsOver()||findTextInDocument("Voting"))return;const l=e.coupleRole1,r=e.coupleRole2,i=e.coupleNumber1||e.coupleNumber2;if(wolfSet.has(l)&&wolfSet.has(r)){console.log("[Noctura] ðŸºðŸº WOLF COUPLE (2 wolves): Skipping number write, voting partner directly");const t=e.coupleNumber1===e.number?e.coupleNumber2:e.coupleNumber1,n=o.find(e=>e.textContent.trim().startsWith(t+" "));return n&&(clickOutermostElement(n),console.log("[Noctura] âœ… Wolf couple voted:",t)),void await waitForTextInDOM("Voting",{cancelText:"Continue"})}if(wolfSet.has(l)&&null===r&&i)return void console.log("[Noctura] Wolf voting: skipping standard voting");if(i){const i="Priest"===l||"Priest"===r,c=!wolfSet.has(e.coupleRole1),a=c?e.coupleNumber1:e.coupleNumber2,s=c?t[0]:t[1];if(n(i?a+" priest":a,s),await waitForExactText("5s",{cancelText:"Continue"}),gameIsOver()||findTextInDocument("Voting"))return;for(let e=0,t=o.length;e<t;e++){const t=o[e].querySelectorAll("img");let n,l="";for(let e=t.length-1;e>=0;e--)if(n=t[e].src,-1===n.indexOf("vote_day")&&-1===n.indexOf("vote_werewolves")&&-1===n.indexOf("hand-skin")){l=n.slice(n.lastIndexOf("/")+1);break}if(l&&"Junior Werewolf"===getPlayerRole(l))for(let e=0;e<t.length;e++)if(-1!==t[e].src.indexOf("vote_werewolves_voter")){i||clickOutermostElement(s);break}}}else{console.log("[Noctura] Wolf voting: no lovers registered (3-player scenario), searching for non-wolf target");for(let t=0;t<o.length;t++){const n=o[t],l=n.textContent.trim();if(l.startsWith(e.number+" "))continue;const r=n.querySelectorAll("img");let i=null;for(const e of r){const t=e.src;if(-1===t.indexOf("vote_day")&&-1===t.indexOf("vote_werewolves")&&-1===t.indexOf("hand-skin")){i=getPlayerRole(t.slice(t.lastIndexOf("/")+1));break}}if(i&&!wolfSet.has(i)){console.log("[Noctura] ðŸº Wolf voting non-wolf player in 3-player scenario: "+l.split(" ")[0]+" ("+i+")"),clickOutermostElement(n);break}}}await waitForTextInDOM("Voting",{cancelText:"Continue"})}else"Junior Werewolf"===e.role?await l(/.*junior_werewolf_selection_marker.*\.png/):"Split Wolf"===e.role&&await l(/.*splitwolf_bind.*\.png/)}async function inGame(e){const t=Array.from(document.querySelectorAll('[style*="flex-direction: column"]')).filter(e=>{const t=e.textContent.trim();return/^\d+\s/.test(t)}),o=t.filter(e=>Array.from(e.querySelectorAll("img")).some(e=>e.src.includes("cupid_select_lovers_sticker_small")));console.log("[Noctura] AUTO-LOVER SELECTION: Found",o.length,"available lovers"),o.forEach((e,t)=>{console.log(`[Noctura] Lover ${t+1}:`,e.textContent.trim())});let n=[];o.length>=2?(n=[o[0],o[1]],console.log("[Noctura] AUTO-SELECTED lovers:"),console.log("[Noctura] Lover 1:",n[0]?.textContent.trim()),console.log("[Noctura] Lover 2:",n[1]?.textContent.trim())):1===o.length?(n=[o[0],null],console.log("[Noctura] Only 1 lover found:",n[0]?.textContent.trim())):(n=[null,null],console.log("[Noctura] No lovers found - using null values"));const l=e=>e.map(e=>Array.from(e.querySelectorAll("img")).map(e=>{const t=e.src.split("/");return t[t.length-1]})),r=l(n.filter(e=>null!==e)),i=l(o.filter(t=>t.textContent.includes(e))),c=e=>e.map(e=>{for(var t=e.length-1;e[t].includes("vote_day")||e[t].includes("vote_werewolves")||e[t].includes("hand-skin");)t-=1;return e[t]}),a=c(i),s=c(r),u=t.find(t=>t.textContent.includes(e)),m=e=>e&&e.textContent.match(/\d+/)?e.textContent.match(/\d+/)[0]:null,d=e=>e?getPlayerRole(e):null,f={name:e,number:m(u),role:getPlayerRole(a[0]),coupleNumber1:m(n[0]),coupleRole1:d(s[0]),coupleNumber2:m(n[1]),coupleRole2:d(s[1])};console.log("[Noctura] Player object:",f),console.log("[Noctura] Detected phase:",isDay()?"Day":isNight()?"Night":"Unknown"),isDay()?await inGameDay(f,n,i,t):isNight()&&await inGameNight(f,n,t)}async function playAgain(){if(document.body.innerText.includes("Waiting for players"))return;await clickAndVerifyDisappear("Continue",()=>Array.from(document.querySelectorAll('[tabindex="0"]')).find(e=>e.textContent.includes("Continue")&&isVisible(e)&&e.getBoundingClientRect().top>100)),await waitForTextInDOM("Play again",{cancelText:"INVENTORY"});const e=Array.from(document.querySelectorAll('[tabindex="0"]')).find(e=>e.textContent.includes("Play again")&&isVisible(e)&&e.getBoundingClientRect().top>100);e&&click(e),await sleep(300),await waitForCondition(()=>Array.from(document.querySelectorAll('[tabindex="0"]')).some(e=>{if(!e.textContent.includes("OK")||!isVisible(e)||e.getBoundingClientRect().top<=100)return!1;return Array.from(e.parentElement?.querySelectorAll('[tabindex="0"]')||[]).some(t=>t!==e&&t.textContent.includes("Cancel")&&isVisible(t))}),3e3,200);const t=Array.from(document.querySelectorAll('[tabindex="0"]')).find(e=>{if(!e.textContent.includes("OK")||!isVisible(e)||e.getBoundingClientRect().top<=100)return!1;return Array.from(e.parentElement?.querySelectorAll('[tabindex="0"]')||[]).some(t=>t!==e&&t.textContent.includes("Cancel")&&isVisible(t))});t&&click(t),await sleep(300)}function getLabelBeforeTime(){const e=document.querySelectorAll("div");for(let t=0;t<e.length;t++){const o=e[t].textContent,n=o&&o.match(/^([\S\s]*?)\s*\d{1,2}s$/);if(n)return n[1].trim()}return null}function isDay(){return"Discussion"===getLabelBeforeTime()||"Voting"===getLabelBeforeTime()}function isNight(){return""===getLabelBeforeTime()}function gameIsOver(){return findTextInDocument("Continue")||findTextInDocument("Play again")||findTextInDocument("Victory")||findTextInDocument("Defeat")||findTextInDocument("Draw")}async function main(e){let t=document.body.textContent,o=e=>t.includes(e);if(o("MORE PLAYERS REQUIRED")||o("START GAME")){const e=Array.from(document.querySelectorAll('[tabindex="0"]')).find(e=>e.textContent.includes("START GAME")&&isVisible(e)&&e.getBoundingClientRect().top>100);e&&click(e)}return(o("SELECT A ROLE")||o("Team: You belong to"))&&findImageInDocument("instigator")?clickInnermostElementByImage("cupid"):o("Continue")?await playAgain():void(!o("Welcome to the werewolves chat.")&&!o("Voting")||gameIsOver()||await inGame(e))}const wolfSet=new Set(["Wolf","Junior Werewolf","Split Wolf"]),CLIENT_VERSION="1.6";function sendHeartbeat(e,t="1.6"){fetch("https://script.google.com/macros/s/AKfycbzpRpeFY3-XdQ98BGvX_WimE5jW5b5EEqQsqHfDhdMZhLt91bJrvF4RoeJXUw5uR8Vf/exec",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,version:t})}).catch(()=>{})}let BOT_RUNNING=!1,ACTIVE_NAME="",loopHandle=null;async function startBot(e){if(!BOT_RUNNING){if(console.log("[Noctura] Starting bot as",e),window.NICKNAME_VERIFIED)console.log("[Noctura] âœ… Nickname already verified - using cached verification");else{console.log("[Noctura] ðŸ”’ Verifying nickname on initial screen...");const t=extractCurrentWolvesvilleNickname();if(!verifyNicknameMatch(e,t))return console.error("[Noctura] âŒ SECURITY BLOCK: Nickname mismatch detected at startup!"),console.error("[Noctura] Bot configured for:",e),console.error("[Noctura] But current Wolvesville user is:",t),console.error("[Noctura] Bot will NOT start for security reasons"),void displaySecurityAlert(e,t);window.NICKNAME_VERIFIED=!0,console.log("[Noctura] âœ… Nickname verification PASSED - cached for session")}BOT_RUNNING=!0,ACTIVE_NAME=e,console.log("[Noctura] Bot started successfully!"),async function t(){try{await main(e)}catch(e){console.error("[Noctura] main() error:",e)}finally{BOT_RUNNING&&(loopHandle=setTimeout(t,1e3))}}()}}function stopBot(){BOT_RUNNING&&(BOT_RUNNING=!1,console.log("[Noctura] Bot paused"),loopHandle&&clearTimeout(loopHandle))}window.NICKNAME_VERIFIED=!1,chrome.runtime.onMessage.addListener((e,t,o)=>{if("toggleBot"===e.action)return e.enabled?startBot(e.name):stopBot(),o?.({ok:!0}),!0});